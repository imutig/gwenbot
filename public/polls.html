<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sondages - xsgwen</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        .poll-form {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--pink-accent);
        }

        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .choice-input {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .choice-input input {
            flex: 1;
        }

        .choice-input button {
            padding: 0.5rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
        }

        .choice-input button:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #ef4444;
        }

        .add-choice-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .add-choice-btn:hover {
            background: var(--bg-card-hover);
        }

        .duration-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .duration-btn {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .duration-btn.active {
            background: var(--pink-accent);
            color: white;
            border-color: var(--pink-accent);
        }

        .submit-poll-btn {
            width: 100%;
            padding: 1rem;
            background: var(--pink-accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-poll-btn:hover {
            background: var(--pink-dark);
            transform: translateY(-2px);
        }

        .submit-poll-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .polls-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .poll-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .poll-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .poll-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .poll-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .poll-status.active {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .poll-status.completed,
        .poll-status.terminated {
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .poll-choices {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .poll-choice {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .poll-choice-bar {
            flex: 1;
            height: 32px;
            background: var(--bg-input);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .poll-choice-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--pink-accent), var(--pink-main));
            transition: width 0.3s ease;
        }

        .poll-choice-text {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.9rem;
            font-weight: 500;
            z-index: 1;
        }

        .poll-choice-votes {
            min-width: 50px;
            text-align: right;
            font-weight: 600;
            color: var(--pink-accent);
        }

        .poll-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .end-poll-btn {
            padding: 0.5rem 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .end-poll-btn:hover {
            background: #ef4444;
            color: white;
        }

        .no-polls {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .login-container {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            text-align: center;
            padding: 3rem;
            max-width: 400px;
        }

        .twitch-btn {
            background: #9146FF;
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .twitch-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>
    <!-- Floral Background -->
    <div class="floral-bg">
        <svg class="flower flower-1" viewBox="0 0 100 100">
            <g transform="translate(50,50)">
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(0)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(60)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(120)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(180)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(240)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(300)" />
            </g>
        </svg>
        <svg class="flower flower-2" viewBox="0 0 100 100">
            <g transform="translate(50,50)">
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(0)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(60)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(120)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(180)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(240)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(300)" />
            </g>
        </svg>
    </div>
    <!-- Dynamic Navbar -->
    <div id="navbar-placeholder"></div>

<!-- Main Content -->
    <main class="main-content">
        <!-- Loading -->
        <div id="loading" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted);">Chargement...</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-container" style="display: none;">
            <div class="glass-card login-card animate-slideIn">
                <i data-lucide="bar-chart-2"
                    style="width: 64px; height: 64px; color: var(--pink-accent); margin-bottom: 1rem;"></i>
                <h1 style="margin-bottom: 0.5rem;">Sondages</h1>
                <p style="color: var(--text-muted); margin-bottom: 2rem;">
                    Connecte-toi pour cr√©er et g√©rer les sondages Twitch.
                </p>
                <a href="/auth/login" class="twitch-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;">
                        <path
                            d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z" />
                    </svg>
                    Connexion avec Twitch
                </a>
            </div>
        </div>

        <!-- Polls Dashboard -->
        <div id="pollsDashboard" style="display: none;">
            <h1 class="animate-slideIn"
                style="font-size: 1.75rem; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="bar-chart-2" style="color: var(--pink-accent);"></i>
                Sondages Twitch
            </h1>

            <!-- Create Poll Form -->
            <div class="poll-form animate-slideIn">
                <h3 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i data-lucide="plus-circle" style="color: var(--pink-accent);"></i>
                    Cr√©er un sondage
                </h3>

                <div class="form-group">
                    <label>Question (max 60 caract√®res)</label>
                    <input type="text" id="pollTitle" placeholder="Quel jeu voulez-vous voir ?" maxlength="60">
                </div>

                <div class="form-group">
                    <label>Options (2-5 choix, max 25 caract√®res chacun)</label>
                    <div id="choicesContainer" class="choices-container">
                        <div class="choice-input">
                            <input type="text" class="choice-field" placeholder="Option 1" maxlength="25">
                        </div>
                        <div class="choice-input">
                            <input type="text" class="choice-field" placeholder="Option 2" maxlength="25">
                        </div>
                    </div>
                    <button id="addChoiceBtn" class="add-choice-btn" onclick="addChoice()">
                        + Ajouter une option
                    </button>
                </div>

                <div class="form-group">
                    <label>Dur√©e</label>
                    <div class="duration-options">
                        <button class="duration-btn" data-duration="30" onclick="setDuration(30)">30s</button>
                        <button class="duration-btn active" data-duration="60" onclick="setDuration(60)">1 min</button>
                        <button class="duration-btn" data-duration="120" onclick="setDuration(120)">2 min</button>
                        <button class="duration-btn" data-duration="300" onclick="setDuration(300)">5 min</button>
                        <button class="duration-btn" data-duration="600" onclick="setDuration(600)">10 min</button>
                    </div>
                </div>

                <button id="submitPollBtn" class="submit-poll-btn" onclick="createPoll()">
                    üìä Lancer le sondage
                </button>
            </div>

            <!-- Active/Recent Polls -->
            <h3 class="animate-slideIn" style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="list" style="color: var(--pink-accent);"></i>
                Sondages r√©cents
            </h3>

            <div id="pollsList" class="polls-list animate-slideIn">
                <div class="no-polls">
                    <i data-lucide="inbox" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                    <p>Aucun sondage r√©cent</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Powered by <a href="#">GwenBot</a></p>
    </footer>

    <script src="/js/main.js"></script>
    <script>
        let selectedDuration = 60;
        let pollRefreshInterval = null;

        // Check auth and initialize
        async function init() {
            try {
                const res = await fetch('/api/auth/user');
                const data = await res.json();

                document.getElementById('loading').style.display = 'none';

                if (!data.authenticated || !data.isAdmin) {
                    document.getElementById('loginSection').style.display = 'flex';
                    lucide.createIcons();
                    return;
                }

                document.getElementById('pollsDashboard').style.display = 'block';
                loadPolls();

                // Refresh polls every 5 seconds
                pollRefreshInterval = setInterval(loadPolls, 5000);

                lucide.createIcons();
            } catch (e) {
                console.error('Init error:', e);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginSection').style.display = 'flex';
            }
        }

        function setDuration(seconds) {
            selectedDuration = seconds;
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.duration) === seconds);
            });
        }

        function addChoice() {
            const container = document.getElementById('choicesContainer');
            const choiceCount = container.querySelectorAll('.choice-input').length;

            if (choiceCount >= 5) {
                alert('Maximum 5 options');
                return;
            }

            const div = document.createElement('div');
            div.className = 'choice-input';
            div.innerHTML = `
                <input type="text" class="choice-field" placeholder="Option ${choiceCount + 1}" maxlength="25">
                <button onclick="removeChoice(this)">‚úï</button>
            `;
            container.appendChild(div);

            if (container.querySelectorAll('.choice-input').length >= 5) {
                document.getElementById('addChoiceBtn').style.display = 'none';
            }
        }

        function removeChoice(btn) {
            const container = document.getElementById('choicesContainer');
            if (container.querySelectorAll('.choice-input').length <= 2) {
                alert('Minimum 2 options requises');
                return;
            }
            btn.closest('.choice-input').remove();
            document.getElementById('addChoiceBtn').style.display = 'block';
        }

        async function createPoll() {
            const title = document.getElementById('pollTitle').value.trim();
            const choiceInputs = document.querySelectorAll('.choice-field');
            const choices = Array.from(choiceInputs).map(i => i.value.trim()).filter(v => v);

            if (!title) {
                alert('Entre une question');
                return;
            }

            if (choices.length < 2) {
                alert('Minimum 2 options requises');
                return;
            }

            const btn = document.getElementById('submitPollBtn');
            btn.disabled = true;
            btn.textContent = 'Cr√©ation...';

            try {
                const res = await fetch('/api/polls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, choices, duration: selectedDuration })
                });

                const data = await res.json();

                if (data.success) {
                    // Clear form
                    document.getElementById('pollTitle').value = '';
                    document.querySelectorAll('.choice-field').forEach(i => i.value = '');

                    loadPolls();
                } else {
                    alert('Erreur: ' + (data.error || 'Impossible de cr√©er le sondage'));
                }
            } catch (e) {
                console.error('Error creating poll:', e);
                alert('Erreur lors de la cr√©ation');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üìä Lancer le sondage';
            }
        }

        async function loadPolls() {
            try {
                const res = await fetch('/api/polls');
                const data = await res.json();

                const container = document.getElementById('pollsList');

                if (!data.polls || data.polls.length === 0) {
                    container.innerHTML = `
                        <div class="no-polls">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin-bottom: 1rem;"></i>
                            <p>Aucun sondage r√©cent</p>
                        </div>
                    `;
                    lucide.createIcons();
                    return;
                }

                container.innerHTML = data.polls.map(poll => {
                    const totalVotes = poll.choices.reduce((sum, c) => sum + c.votes, 0);
                    const statusClass = poll.status.toLowerCase();
                    const isActive = poll.status === 'ACTIVE';

                    const choicesHtml = poll.choices.map(choice => {
                        const percent = totalVotes > 0 ? (choice.votes / totalVotes * 100) : 0;
                        return `
                            <div class="poll-choice">
                                <div class="poll-choice-bar">
                                    <div class="poll-choice-fill" style="width: ${percent}%"></div>
                                    <span class="poll-choice-text">${choice.title}</span>
                                </div>
                                <span class="poll-choice-votes">${choice.votes}</span>
                            </div>
                        `;
                    }).join('');

                    const startedAt = new Date(poll.started_at).toLocaleString('fr-FR');
                    const endBtn = isActive
                        ? `<button class="end-poll-btn" onclick="endPoll('${poll.id}')">Terminer</button>`
                        : '';

                    return `
                        <div class="poll-card">
                            <div class="poll-header">
                                <div class="poll-title">${poll.title}</div>
                                <span class="poll-status ${statusClass}">${poll.status}</span>
                            </div>
                            <div class="poll-choices">${choicesHtml}</div>
                            <div class="poll-footer">
                                <span>${totalVotes} vote${totalVotes !== 1 ? 's' : ''} ‚Ä¢ ${startedAt}</span>
                                ${endBtn}
                            </div>
                        </div>
                    `;
                }).join('');

                lucide.createIcons();
            } catch (e) {
                console.error('Error loading polls:', e);
            }
        }

        async function endPoll(pollId) {
            if (!confirm('Terminer ce sondage ?')) return;

            try {
                const res = await fetch(`/api/polls/${pollId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ archive: false })
                });

                const data = await res.json();

                if (data.success) {
                    loadPolls();
                } else {
                    alert('Erreur: ' + (data.error || 'Impossible de terminer le sondage'));
                }
            } catch (e) {
                console.error('Error ending poll:', e);
                alert('Erreur');
            }
        }

        // Cleanup on page leave
        window.addEventListener('beforeunload', () => {
            if (pollRefreshInterval) clearInterval(pollRefreshInterval);
        });

        init();
    </script>
    <script src="/js/navbar.js"></script>
</body>

</html>