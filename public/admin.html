<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - xsgwen</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <style>
        .login-container {
            min-height: 80vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            text-align: center;
            padding: 3rem;
            max-width: 400px;
        }

        .twitch-btn {
            background: #9146FF;
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: all 0.2s;
        }

        .twitch-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid var(--pink-main);
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
        }

        .logout-btn:hover {
            background: var(--bg-input);
        }

        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-box .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--pink-accent);
        }

        .stat-box .label {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .section-title {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-muted);
        }

        .record-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-input);
            border-radius: 10px;
            margin-bottom: 0.5rem;
        }

        .record-input {
            width: 80px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            text-align: center;
        }

        .save-btn {
            padding: 0.5rem 1rem;
            background: var(--pink-main);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .save-btn:hover {
            background: var(--pink-accent);
        }

        .emote-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .emote-tag {
            background: var(--bg-input);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .access-denied {
            text-align: center;
            padding: 3rem;
        }

        .recent-streams {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stream-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: var(--bg-input);
            border-radius: 10px;
        }

        .stream-title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .stream-meta {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
    </style>
</head>

<body>
    <!-- Floral Background -->
    <div class="floral-bg">
        <svg class="flower flower-1" viewBox="0 0 100 100">
            <g transform="translate(50,50)">
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(0)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(60)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(120)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(180)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(240)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(300)" />
            </g>
        </svg>
        <svg class="flower flower-2" viewBox="0 0 100 100">
            <g transform="translate(50,50)">
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(0)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(60)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(120)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(180)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(240)" />
                <path d="M0,-35 C10,-35 15,-20 0,0 C-15,-20 -10,-35 0,-35" transform="rotate(300)" />
            </g>
        </svg>
    </div>
    <!-- Dynamic Navbar -->
    <div id="navbar-placeholder"></div>

<!-- Main Content -->
    <main class="main-content">
        <!-- Loading -->
        <div id="loading" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted);">Chargement...</p>
        </div>

        <!-- Login Section (hidden by default) -->
        <div id="loginSection" class="login-container" style="display: none;">
            <div class="glass-card login-card animate-slideIn">
                <i data-lucide="shield"
                    style="width: 64px; height: 64px; color: var(--pink-accent); margin-bottom: 1rem;"></i>
                <h1 style="margin-bottom: 0.5rem;">Espace Admin</h1>
                <p style="color: var(--text-muted); margin-bottom: 2rem;">
                    Connecte-toi avec Twitch pour acc√©der au panneau de gestion.
                </p>
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <a href="/auth/login" class="twitch-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;">
                        <path
                            d="M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z" />
                    </svg>
                    Connexion avec Twitch
                </a>
            </div>
        </div>

        <!-- Access Denied Section -->
        <div id="accessDenied" class="glass-card access-denied animate-slideIn" style="display: none;">
            <i data-lucide="lock" style="width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 1rem;"></i>
            <h2>Acc√®s refus√©</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                Seule la streameuse et ses mod√©rateurs peuvent acc√©der √† cette page.
            </p>
            <a href="/auth/logout" class="btn btn-primary">D√©connexion</a>
        </div>

        <!-- Admin Dashboard (hidden by default) -->
        <div id="adminDashboard" style="display: none;">
            <div class="admin-header animate-slideIn">
                <div>
                    <h1 style="font-size: 1.75rem; display: flex; align-items: center; gap: 0.5rem;">
                        <i data-lucide="settings" style="color: var(--pink-accent);"></i>
                        Panneau Admin
                    </h1>
                    <p style="color: var(--text-muted);">Gestion du bot et des statistiques</p>
                </div>
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                    <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">
                        <div id="userName" style="font-weight: 600;"></div>
                        <a href="/auth/logout" class="logout-btn">D√©connexion</a>
                    </div>
                </div>
            </div>

            <!-- Stream Stats -->
            <h3 class="section-title"><i data-lucide="tv"></i> Statistiques des streams</h3>
            <div class="admin-grid animate-slideIn">
                <div class="stat-box">
                    <div class="value" id="totalStreams">0</div>
                    <div class="label">Streams enregistr√©s</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalHours">0h</div>
                    <div class="label">Heures de stream</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="peakViewers">0</div>
                    <div class="label">Pic de viewers</div>
                </div>
                <div class="stat-box">
                    <div class="value" id="totalChatters">0</div>
                    <div class="label">Chatters uniques</div>
                </div>
            </div>

            <!-- Recent Streams -->
            <div class="glass-card animate-slideIn" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h3 class="section-title"><i data-lucide="clock"></i> Derniers streams</h3>
                <div id="recentStreams" class="recent-streams">
                    <p style="color: var(--text-muted); text-align: center;">Aucun stream enregistr√©</p>
                </div>
            </div>

            <!-- Records Management -->
            <div class="glass-card animate-slideIn" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h3 class="section-title"><i data-lucide="trophy"></i> Records Cemantix</h3>

                <!-- Current Records Display -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">üá´üá∑ C√©mantix
                        </div>
                        <div id="currentRecordFR"
                            style="font-size: 1.5rem; font-weight: 700; color: var(--pink-accent);">-</div>
                    </div>
                    <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px; text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.25rem;">üá¨üáß Cemantle
                        </div>
                        <div id="currentRecordEN"
                            style="font-size: 1.5rem; font-weight: 700; color: var(--pink-accent);">-</div>
                    </div>
                </div>

                <!-- New Record Input -->
                <div style="background: var(--bg-input); padding: 1rem; border-radius: 10px;">
                    <div style="font-size: 0.9rem; font-weight: 500; margin-bottom: 0.75rem;">Nouveau record</div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <select id="recordLangSelect" class="input" style="width: auto; padding: 0.5rem;">
                            <option value="fr">üá´üá∑ C√©mantix</option>
                            <option value="en">üá¨üáß Cemantle</option>
                        </select>
                        <input type="number" id="newRecordValue" class="record-input" placeholder="Score"
                            style="width: 100px;">
                        <button class="save-btn" onclick="submitNewRecord()">Enregistrer</button>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                        Le record sera mis √† jour s'il est meilleur (plus bas) que l'actuel
                    </p>
                </div>
            </div>

            <!-- Emotes Config -->
            <div class="glass-card animate-slideIn" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h3 class="section-title"><i data-lucide="smile"></i> Emotes track√©es</h3>
                <div id="emotesContainer" class="emote-list">
                    <!-- Emotes will be loaded here -->
                </div>
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 1rem;">
                    Pour modifier les emotes, contacte le d√©veloppeur.
                </p>
            </div>

            <!-- User Management -->
            <div class="glass-card animate-slideIn" style="padding: 1.5rem;" id="userManagementSection">
                <h3 class="section-title"><i data-lucide="users"></i> Utilisateurs autoris√©s</h3>
                <div id="usersContainer"
                    style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1rem;">
                    <!-- Users will be loaded here -->
                </div>
                <div id="addUserForm" style="display: none; margin-top: 1rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="newUserInput" class="input" style="flex: 1;"
                            placeholder="Pseudo Twitch...">
                        <button class="save-btn" onclick="addUser()">Ajouter</button>
                    </div>
                    <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">
                        Seul le super admin peut ajouter ou supprimer des utilisateurs.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>Powered by <a href="#">GwenBot</a></p>
    </footer>

    <script src="/js/main.js"></script>
    <script>
        // Check for error in URL
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');
        if (error) {
            const errorMessages = {
                'invalid_state': 'Erreur de s√©curit√©. R√©essaye.',
                'token_failed': 'Impossible d\'obtenir le token Twitch.',
                'user_failed': 'Impossible de r√©cup√©rer les infos utilisateur.',
                'auth_failed': 'Erreur d\'authentification.'
            };
            document.getElementById('errorMessage').textContent = errorMessages[error] || 'Erreur inconnue';
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Initialize
        async function init() {
            try {
                const res = await fetch('/api/auth/user');
                const data = await res.json();

                document.getElementById('loading').style.display = 'none';

                if (!data.authenticated) {
                    document.getElementById('loginSection').style.display = 'flex';
                    lucide.createIcons();
                    return;
                }

                if (!data.isAdmin) {
                    document.getElementById('accessDenied').style.display = 'block';
                    lucide.createIcons();
                    return;
                }

                // Show admin dashboard
                document.getElementById('adminDashboard').style.display = 'block';
                document.getElementById('userAvatar').src = data.user.profile_image_url;
                document.getElementById('userName').textContent = data.user.display_name;

                // Load data
                loadStreamStats();
                loadRecords();
                loadEmotes();
                loadUsers();

                lucide.createIcons();
            } catch (e) {
                console.error('Init error:', e);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loginSection').style.display = 'flex';
            }
        }

        async function loadStreamStats() {
            try {
                const res = await fetch('/api/admin/stream-stats');
                const data = await res.json();

                document.getElementById('totalStreams').textContent = data.totalStreams;
                document.getElementById('totalHours').textContent = data.totalHours + 'h';
                document.getElementById('peakViewers').textContent = data.allTimePeak;
                document.getElementById('totalChatters').textContent = data.totalUniqueChatters;

                // Recent streams
                const container = document.getElementById('recentStreams');
                if (data.recentStreams?.length > 0) {
                    container.innerHTML = data.recentStreams.map(s => {
                        const date = new Date(s.started_at).toLocaleDateString('fr-FR');
                        return `
                            <div class="stream-item">
                                <div>
                                    <div class="stream-title">${s.title || 'Sans titre'}</div>
                                    <div class="stream-meta">${s.game_name || 'N/A'} ‚Ä¢ ${date}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: var(--pink-accent);">${s.peak_viewers} viewers</div>
                                    <div class="stream-meta">${s.total_chatters} chatters</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } catch (e) {
                console.error('Error loading stream stats:', e);
            }
        }

        async function loadRecords() {
            try {
                const res = await fetch('/api/admin/records');
                const data = await res.json();

                // Display FR records
                const frAlltime = data.fr?.alltime ?? '-';
                const frMonthly = data.fr?.monthly ?? '-';
                document.getElementById('currentRecordFR').innerHTML =
                    `${frAlltime} <span style="font-size: 0.7rem; color: var(--text-muted);">(mois: ${frMonthly})</span>`;

                // Display EN records  
                const enAlltime = data.en?.alltime ?? '-';
                const enMonthly = data.en?.monthly ?? '-';
                document.getElementById('currentRecordEN').innerHTML =
                    `${enAlltime} <span style="font-size: 0.7rem; color: var(--text-muted);">(mois: ${enMonthly})</span>`;
            } catch (e) {
                console.error('Error loading records:', e);
            }
        }

        async function submitNewRecord() {
            const lang = document.getElementById('recordLangSelect').value;
            const value = parseInt(document.getElementById('newRecordValue').value);

            if (isNaN(value) || value <= 0) {
                alert('Entre un score valide');
                return;
            }

            try {
                const res = await fetch('/api/admin/records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang, value })
                });

                const data = await res.json();
                if (data.success) {
                    if (data.updated) {
                        let msg = '‚úÖ Nouveau record !\n\n';
                        for (const update of data.updates) {
                            const typeName = update.type === 'alltime' ? 'All-time' : 'Mensuel';
                            msg += `${typeName}: ${update.old ?? 'N/A'} ‚Üí ${update.new}\n`;
                        }
                        alert(msg);
                    } else {
                        alert(data.message);
                    }
                    document.getElementById('newRecordValue').value = '';
                    loadRecords();
                } else {
                    alert('Erreur: ' + (data.error || 'Inconnue'));
                }
            } catch (e) {
                console.error('Error submitting record:', e);
                alert('Erreur lors de l\'envoi');
            }
        }

        async function loadEmotes() {
            try {
                const res = await fetch('/api/admin/config');
                const data = await res.json();

                const container = document.getElementById('emotesContainer');
                container.innerHTML = (data.emotes || []).map(e =>
                    `<span class="emote-tag">${e}</span>`
                ).join('');
            } catch (e) {
                console.error('Error loading emotes:', e);
            }
        }

        let canManageUsers = false;
        let superAdmins = [];

        async function loadUsers() {
            try {
                const res = await fetch('/api/admin/users');
                const data = await res.json();

                canManageUsers = data.canManage;
                superAdmins = data.superAdmins || [];

                const container = document.getElementById('usersContainer');
                container.innerHTML = (data.users || []).map(u => {
                    const isSuperAdmin = superAdmins.includes(u);
                    const removeBtn = canManageUsers && !isSuperAdmin
                        ? `<button onclick="removeUser('${u}')" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem;">‚úï</button>`
                        : '';
                    const badge = isSuperAdmin
                        ? '<span style="background: var(--pink-accent); color: white; font-size: 0.7rem; padding: 0.2rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;">Super Admin</span>'
                        : '';
                    return `
                        <div class="record-row">
                            <span>${u}${badge}</span>
                            ${removeBtn}
                        </div>
                    `;
                }).join('');

                // Show add form if super admin
                if (canManageUsers) {
                    document.getElementById('addUserForm').style.display = 'block';
                }
            } catch (e) {
                console.error('Error loading users:', e);
            }
        }

        async function addUser() {
            const input = document.getElementById('newUserInput');
            const username = input.value.trim();

            if (!username) {
                alert('Entre un pseudo');
                return;
            }

            try {
                const res = await fetch('/api/admin/users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });

                const data = await res.json();
                if (data.success) {
                    input.value = '';
                    loadUsers();
                } else {
                    alert('Erreur: ' + (data.error || 'Inconnue'));
                }
            } catch (e) {
                console.error('Error adding user:', e);
                alert('Erreur lors de l\'ajout');
            }
        }

        async function removeUser(username) {
            if (!confirm(`Supprimer ${username} des utilisateurs autoris√©s ?`)) return;

            try {
                const res = await fetch(`/api/admin/users/${encodeURIComponent(username)}`, {
                    method: 'DELETE'
                });

                const data = await res.json();
                if (data.success) {
                    loadUsers();
                } else {
                    alert('Erreur: ' + (data.error || 'Inconnue'));
                }
            } catch (e) {
                console.error('Error removing user:', e);
                alert('Erreur lors de la suppression');
            }
        }

        // Cemantix Session Control
        async function loadCemantixStatus() {
            try {
                const res = await fetch('/api/admin/cemantix/status');
                const data = await res.json();

                const statusText = document.getElementById('sessionStatusText');
                const details = document.getElementById('sessionDetails');
                const indicator = document.getElementById('sessionIndicator');
                const btnStartFR = document.getElementById('btnStartFR');
                const btnStartEN = document.getElementById('btnStartEN');
                const btnStop = document.getElementById('btnStop');

                if (data.active) {
                    const gameName = data.lang === 'en' ? 'Cemantle' : 'C√©mantix';
                    const mins = Math.floor(data.duration / 60);
                    const secs = data.duration % 60;

                    statusText.textContent = `${gameName} en cours`;
                    details.textContent = `${data.guessCount} mots test√©s ‚Ä¢ ${mins}:${secs.toString().padStart(2, '0')}`;
                    indicator.style.background = '#22c55e';

                    btnStartFR.style.display = 'none';
                    btnStartEN.style.display = 'none';
                    btnStop.style.display = 'block';
                } else {
                    statusText.textContent = 'Session inactive';
                    details.textContent = 'Pr√™t √† d√©marrer une partie';
                    indicator.style.background = 'var(--text-muted)';

                    btnStartFR.style.display = 'block';
                    btnStartEN.style.display = 'block';
                    btnStop.style.display = 'none';
                }
            } catch (e) {
                console.error('Error loading Cemantix status:', e);
            }
        }

        async function startCemantix(lang) {
            try {
                const res = await fetch('/api/admin/cemantix/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lang })
                });

                const data = await res.json();
                if (data.success) {
                    loadCemantixStatus();
                } else {
                    alert('Erreur: ' + (data.error || 'Inconnue'));
                }
            } catch (e) {
                console.error('Error starting Cemantix:', e);
                alert('Erreur lors du d√©marrage');
            }
        }

        async function stopCemantix() {
            if (!confirm('Arr√™ter la session Cemantix en cours ?')) return;

            try {
                const res = await fetch('/api/admin/cemantix/stop', {
                    method: 'POST'
                });

                const data = await res.json();
                if (data.success) {
                    let msg = `Session termin√©e !\n\n`;
                    if (data.winner) {
                        msg += `üèÜ Gagnant: ${data.winner}\n`;
                        msg += `üéØ Mot: ${data.winningWord}\n`;
                    }
                    msg += `üìä ${data.guessCount} mots test√©s\n`;
                    msg += `‚è±Ô∏è Dur√©e: ${Math.floor(data.duration / 60)}:${(data.duration % 60).toString().padStart(2, '0')}`;

                    alert(msg);
                    loadCemantixStatus();
                } else {
                    alert('Erreur: ' + (data.error || 'Inconnue'));
                }
            } catch (e) {
                console.error('Error stopping Cemantix:', e);
                alert('Erreur lors de l\'arr√™t');
            }
        }

        init();
    </script>
    <script src="/js/navbar.js"></script>
</body>

</html>